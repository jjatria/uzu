#!/usr/bin/env perl6

use v6;
use Uzu;

multi MAIN('webserver', Str $build_dir) {
  Uzu::server(src_dir => $build_dir);
}

multi MAIN('build', Str $layout) {
  Uzu::config(base => './partials', layout => $layout);
  Uzu::render();
}

multi MAIN('serve', Str $layout) {

  unless 'partials'.IO.e {
    note "No partials .mustache files available";
    exit(1);
  }

  my @watchlist = ['layouts/', 'partials/'];

  say "Attempting to start server";
  Uzu::config(base => './partials', layout => $layout);
  my $last;

  # Start server
  my $app = Uzu::serve(build_dir => 'build');
	
	react {
		whenever Uzu::watch-dirs(@watchlist.grep: *.IO.e) -> $e {
			if $e.path().grep: /.mustache$/ and (!$last.defined or now - $last > 8) {
				$last = now;
				say "Change detected [$e.path(), $e.event()]. Restarting server.";
				Uzu::render();
			}
		}
	}
}
